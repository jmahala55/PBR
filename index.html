<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitcher Query Tool</title>
</head>
<body>
    <h1>Pitcher Query Tool</h1>
    
    <div>
        <label for="dateSelect">Select Date:</label>
        <select id="dateSelect">
            <option value="">Loading dates...</option>
        </select>
    </div>
    
    <div>
        <label for="pitcherSelect">Select Pitcher (Optional):</label>
        <select id="pitcherSelect" disabled>
            <option value="">Select a date first</option>
        </select>
    </div>
    
    <div>
        <button id="sendEmailBtn" onclick="sendEmails()" disabled>Send Emails to All Pitchers</button>
    </div>
    
    <div id="loading" style="display: none;">
        <p>Loading...</p>
    </div>
    
    <div id="error" style="display: none; color: red;"></div>
    <div id="success" style="display: none; color: green;"></div>
    
    <div id="stats"></div>
    
    <h2>Unique Pitchers</h2>
    <div id="pitchers-list"></div>
    
    <div id="pitcher-details" style="display: none;">
        <h3>Pitcher Details</h3>
        <div id="details-content"></div>
    </div>
    
    <div id="email-results" style="display: none;">
        <div id="email-summary"></div>
        <div id="email-details"></div>
    </div>
    
    <div id="email-results" style="display: none;">
        <div id="email-summary"></div>
        <div id="email-details"></div>
    </div>

    <script>
        // Global variables
        let currentDate = '';
        let currentPitchers = [];
        
        // DOM elements
        const dateSelect = document.getElementById('dateSelect');
        const pitcherSelect = document.getElementById('pitcherSelect');
        const sendEmailBtn = document.getElementById('sendEmailBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const success = document.getElementById('success');
        const statsDiv = document.getElementById('stats');
        const pitchersList = document.getElementById('pitchers-list');
        const pitcherDetails = document.getElementById('pitcher-details');
        const detailsContent = document.getElementById('details-content');
        const emailResults = document.getElementById('email-results');
        const emailSummary = document.getElementById('email-summary');
        const emailDetails = document.getElementById('email-details');
        
        // Utility functions
        function showLoading() {
            loading.style.display = 'block';
        }
        
        function hideLoading() {
            loading.style.display = 'none';
        }
        
        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
            success.style.display = 'none';
        }
        
        function showSuccess(message) {
            success.textContent = message;
            success.style.display = 'block';
            error.style.display = 'none';
        }
        
        function hideMessages() {
            error.style.display = 'none';
            success.style.display = 'none';
        }
        
        // API functions
        async function fetchDates() {
            try {
                const response = await fetch('/api/dates');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                return data.dates;
            } catch (err) {
                console.error('Error fetching dates:', err);
                throw err;
            }
        }
        
        async function fetchPitchers(date) {
            try {
                const response = await fetch(`/api/pitchers?date=${encodeURIComponent(date)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                return data.pitchers;
            } catch (err) {
                console.error('Error fetching pitchers:', err);
                throw err;
            }
        }
        
        async function fetchPitcherDetails(date, pitcher) {
            try {
                const response = await fetch(`/api/pitcher-details?date=${encodeURIComponent(date)}&pitcher=${encodeURIComponent(pitcher)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                return data.pitch_data;
            } catch (err) {
                console.error('Error fetching pitcher details:', err);
                throw err;
            }
        }
        
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                return data;
            } catch (err) {
                console.error('Error fetching stats:', err);
                throw err;
            }
        }
        
        async function sendEmailsToAll(date) {
            try {
                const response = await fetch('/api/send-emails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ date: date })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                return data;
            } catch (err) {
                console.error('Error sending emails:', err);
                throw err;
            }
        }
        
        // UI functions
        function populateDateSelect(dates) {
            dateSelect.innerHTML = '<option value="">Select a date...</option>';
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                dateSelect.appendChild(option);
            });
        }
        
        function populatePitcherSelect(pitchers) {
            pitcherSelect.innerHTML = '<option value="">Select a pitcher...</option>';
            pitchers.forEach(pitcher => {
                const option = document.createElement('option');
                option.value = pitcher;
                option.textContent = pitcher;
                pitcherSelect.appendChild(option);
            });
            pitcherSelect.disabled = false;
        }
        
        function displayPitchers(pitchers) {
            // Remove this function content since we're not showing the pitchers list
        }
        
        function displayStats(stats) {
            const matching = stats.matching_stats;
            
            statsDiv.innerHTML = `
                <h3>Name Matching Analysis</h3>
                <p><strong>Total Prospects in Info Table:</strong> ${matching.total_in_info}</p>
                <p><strong>Total Pitchers in Test Table:</strong> ${matching.total_in_test}</p>
                <p><strong>Names that Match:</strong> ${matching.matched_names} 
                   (${((matching.matched_names / matching.total_in_info) * 100).toFixed(1)}%)</p>
                <p><strong>Matched with Email:</strong> ${matching.matched_with_email}</p>
                <p><strong>Matched without Email:</strong> ${matching.matched_without_email}</p>
            `;
        }
        
        function displayPitcherDetails(pitchData, pitcherName) {
            if (pitchData.length === 0) {
                detailsContent.innerHTML = '<p>No pitch data found for this pitcher.</p>';
                return;
            }
            
            // Calculate basic stats
            const totalPitches = pitchData.length;
            const avgSpeed = pitchData.reduce((sum, pitch) => sum + (pitch.RelSpeed || 0), 0) / totalPitches;
            const pitchTypes = [...new Set(pitchData.map(pitch => pitch.TaggedPitchType).filter(Boolean))];
            
            let html = `
                <h4>${pitcherName}</h4>
                <p>Total Pitches: ${totalPitches}</p>
                <p>Average Velocity: ${avgSpeed.toFixed(1)} mph</p>
                <p>Pitch Types: ${pitchTypes.length}</p>
                
                <table border="1">
                    <thead>
                        <tr>
                            <th>Pitch #</th>
                            <th>Type</th>
                            <th>Velocity</th>
                            <th>Spin Rate</th>
                            <th>Vert Break</th>
                            <th>Horz Break</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pitchData.forEach(pitch => {
                html += `
                    <tr>
                        <td>${pitch.PitchNo || 'N/A'}</td>
                        <td>${pitch.TaggedPitchType || 'N/A'}</td>
                        <td>${pitch.RelSpeed ? pitch.RelSpeed.toFixed(1) : 'N/A'}</td>
                        <td>${pitch.SpinRate ? pitch.SpinRate.toFixed(0) : 'N/A'}</td>
                        <td>${pitch.InducedVertBreak ? pitch.InducedVertBreak.toFixed(1) : 'N/A'}</td>
                        <td>${pitch.HorzBreak ? pitch.HorzBreak.toFixed(1) : 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            detailsContent.innerHTML = html;
            pitcherDetails.style.display = 'block';
        }
        
        // Event handlers
        dateSelect.addEventListener('change', async (e) => {
            const selectedDate = e.target.value;
            if (!selectedDate) {
                pitcherSelect.disabled = true;
                pitcherSelect.innerHTML = '<option value="">Select a date first</option>';
                pitchersList.innerHTML = '';
                pitcherDetails.style.display = 'none';
                return;
            }
            
            currentDate = selectedDate;
            showLoading();
            hideMessages();
            
            try {
                const pitchers = await fetchPitchers(selectedDate);
                currentPitchers = pitchers;
                
                populatePitcherSelect(pitchers);
                
                // Enable send email button
                sendEmailBtn.disabled = false;
                
                showSuccess(`Found ${pitchers.length} unique pitchers for ${selectedDate}`);
            } catch (err) {
                showError(`Error loading pitchers: ${err.message}`);
                pitcherSelect.disabled = true;
                sendEmailBtn.disabled = true;
            } finally {
                hideLoading();
            }
        });
        
        // Send emails function
        async function sendEmails() {
            if (!currentDate) {
                showError('Please select a date first');
                return;
            }
            
            if (!confirm('Are you sure you want to send emails to all matched pitchers for this date?')) {
                return;
            }
            
            showLoading();
            hideMessages();
            sendEmailBtn.disabled = true;
            
            try {
                const result = await sendEmailsToAll(currentDate);
                
                if (result.success) {
                    displayEmailResults(result);
                    showSuccess('Emails sent! See detailed results below.');
                } else {
                    showError('Failed to send emails');
                }
            } catch (err) {
                showError(`Error sending emails: ${err.message}`);
            } finally {
                hideLoading();
                sendEmailBtn.disabled = false;
            }
        }
        
        function displayEmailResults(result) {
            const summary = result.summary;
            
            // Display simple summary - just the match ratio (use emails_sent_successfully)
            emailSummary.innerHTML = `
                <h4>${summary.emails_sent_successfully}/${summary.total_prospects_in_info} Info Match</h4>
            `;
            
            // Display only successfully sent emails table
            let detailsHtml = '';
            
            if (result.sent_emails.length > 0) {
                detailsHtml += `
                    <h4>Emails Successfully Sent (${result.sent_emails.length})</h4>
                    <table border="1" style="width: 100%; margin-bottom: 20px;">
                        <thead>
                            <tr style="background-color: #e8f5e8;">
                                <th>Name</th>
                                <th>Email</th>
                                <th>Event</th>
                                <th>Type</th>
                                <th>Pitches</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                result.sent_emails.forEach(email => {
                    detailsHtml += `
                        <tr>
                            <td>${email.pitcher}</td>
                            <td>${email.email}</td>
                            <td>${email.event || 'N/A'}</td>
                            <td>${email.type || 'N/A'}</td>
                            <td>${email.pitch_count}</td>
                        </tr>
                    `;
                });
                
                detailsHtml += '</tbody></table>';
            }
            
            emailDetails.innerHTML = detailsHtml;
            emailResults.style.display = 'block';
        }
        
        pitcherSelect.addEventListener('change', async (e) => {
            const selectedPitcher = e.target.value;
            if (!selectedPitcher) {
                pitcherDetails.style.display = 'none';
                return;
            }
            
            loadPitcherDetails(selectedPitcher);
        });
        
        async function loadPitcherDetails(pitcherName) {
            if (!currentDate) return;
            
            showLoading();
            hideMessages();
            
            try {
                const pitchData = await fetchPitcherDetails(currentDate, pitcherName);
                displayPitcherDetails(pitchData, pitcherName);
                
                // Update pitcher select to show selected pitcher
                pitcherSelect.value = pitcherName;
            } catch (err) {
                showError(`Error loading pitcher details: ${err.message}`);
            } finally {
                hideLoading();
            }
        }
        
        // Initialize the application
        async function init() {
            showLoading();
            
            try {
                // Load initial data
                const [dates, stats] = await Promise.all([
                    fetchDates(),
                    fetchStats()
                ]);
                
                populateDateSelect(dates);
                displayStats(stats);
                
                showSuccess('Application loaded successfully!');
            } catch (err) {
                showError(`Error initializing application: ${err.message}`);
            } finally {
                hideLoading();
            }
        }
        
        // Start the application
        init();
    </script>
</body>
</html>